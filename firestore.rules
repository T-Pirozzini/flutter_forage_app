rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ================================================================
    // HELPER FUNCTIONS
    // ================================================================

    // Is the request from an authenticated user?
    function isAuth() {
      return request.auth != null;
    }

    // Is the authenticated user the owner of this document path?
    function isOwner(userId) {
      return isAuth() && request.auth.token.email == userId;
    }

    // Is the authenticated user an admin?
    function isAdmin() {
      return isAuth()
        && exists(/databases/$(database)/documents/Users/$(request.auth.token.email))
        && get(/databases/$(database)/documents/Users/$(request.auth.token.email)).data.isAdmin == true;
    }

    // ================================================================
    // USERS
    // ================================================================
    match /Users/{email} {
      // Any authenticated user can read user profiles (for search, leaderboard, etc.)
      allow read: if isAuth();
      // Only the user themselves can create/update their own profile
      allow create: if isOwner(email);
      allow update: if isOwner(email);
      // Only owner or admin can delete
      allow delete: if isOwner(email) || isAdmin();

      // --- User Subcollections ---

      match /Notifications/{notifId} {
        allow read, delete: if isOwner(email);
        allow update: if isOwner(email); // mark as read
        // Cloud Functions and other users can create notifications
        allow create: if isAuth();
      }

      match /Friends/{friendId} {
        // Owner can read their own friends list
        // Other users can read if they are the friend (for collectionGroup queries)
        allow read: if isOwner(email)
          || (isAuth() && resource.data.friendEmail == request.auth.token.email);
        // Owner manages their own friends list
        allow write: if isOwner(email);
      }

      match /FriendRequests/{requestId} {
        allow read: if isOwner(email);
        // Any authenticated user can send a friend request
        allow create: if isAuth();
        // Only the owner can update (accept/decline) or delete
        allow update, delete: if isOwner(email);
      }

      match /Bookmarks/{bookmarkId} {
        allow read, write: if isOwner(email);
      }

      match /Following/{targetEmail} {
        // Owner has full access
        allow write: if isOwner(email);
        // Allow reads for owner + collectionGroup queries (follower counts)
        allow read: if isAuth();
      }

      match /ActivityFeed/{activityId} {
        allow read, delete: if isOwner(email);
        // Friends' actions can create feed items
        allow create: if isAuth();
        allow update: if isOwner(email);
      }

      match /Collections/{collectionId} {
        // Owner has full access
        allow read, write: if isOwner(email);
        // Other authenticated users can read public collections (collectionGroup query)
        allow read: if isAuth()
          && resource.data.isPublic == true;
      }

      match /Subscriptions/{subId} {
        allow read, write: if isOwner(email);
      }

      match /SavedRecipes/{savedId} {
        allow read, write: if isOwner(email);
      }

      match /EmergencyNotifications/{notifId} {
        // Owner has full access
        allow read, write: if isOwner(email);
        // Other users can read (for collectionGroup queries by emergency contacts)
        allow read: if isAuth();
      }

      match /PostDrafts/{draftId} {
        allow read, write: if isOwner(email);
      }

      // Legacy Markers subcollection (deprecated — migrated to root Markers)
      match /Markers/{markerId} {
        allow read: if isAuth();
        allow create: if isOwner(email);
        allow update, delete: if isOwner(email)
          || (isAuth() && request.auth.token.email == resource.data.markerOwner);
      }
    }

    // ================================================================
    // COLLECTION GROUP RULES
    // collectionGroup() queries need /{path=**}/ wildcard prefix
    // ================================================================

    // Friends collectionGroup — find who has you as a close friend
    match /{path=**}/Friends/{friendId} {
      allow read: if isAuth()
        && resource.data.friendEmail == request.auth.token.email;
    }

    // Following collectionGroup — count followers
    match /{path=**}/Following/{targetEmail} {
      allow read: if isAuth();
    }

    // Collections collectionGroup — browse public collections
    match /{path=**}/Collections/{collectionId} {
      allow read: if isAuth()
        && resource.data.isPublic == true;
    }

    // EmergencyNotifications collectionGroup — emergency contacts
    match /{path=**}/EmergencyNotifications/{notifId} {
      allow read: if isAuth();
    }

    // ================================================================
    // MARKERS (root collection — current)
    // ================================================================
    match /Markers/{markerId} {
      allow read: if isAuth();
      allow create: if isAuth();
      // Only the marker owner can update or delete
      allow update: if isAuth() && request.auth.token.email == resource.data.markerOwner;
      allow delete: if isAuth() && request.auth.token.email == resource.data.markerOwner;
    }

    // ================================================================
    // POSTS
    // ================================================================
    match /Posts/{postId} {
      allow read: if isAuth();
      allow create: if isAuth();
      // Any auth user can update (for likes array)
      allow update: if isAuth();
      // Only the post owner can delete
      allow delete: if isAuth() && request.auth.token.email == resource.data.userEmail;

      match /Comments/{commentId} {
        allow read: if isAuth();
        allow create: if isAuth();
        allow delete: if isAuth();
      }

      match /Likes/{likeId} {
        allow read: if isAuth();
        allow create, delete: if isAuth();
      }
    }

    // ================================================================
    // RECIPES
    // ================================================================
    match /Recipes/{recipeId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAuth() && request.auth.token.email == resource.data.userEmail;

      match /Likes/{likeId} {
        allow read: if isAuth();
        allow create, delete: if isAuth();
      }

      match /Comments/{commentId} {
        allow read: if isAuth();
        allow create: if isAuth();
        allow delete: if isAuth();
      }
    }

    // ================================================================
    // FORAGE REQUESTS
    // ================================================================
    match /ForageRequests/{requestId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAuth();
    }

    // ================================================================
    // DIRECT MESSAGES (user → admin)
    // ================================================================
    match /DirectMessages/{messageId} {
      allow create: if isAuth();
      allow read: if isAdmin() || (isAuth() && request.auth.token.email == resource.data.userEmail);
      allow update, delete: if isAdmin();
    }

    // ================================================================
    // FRIENDSHIP INDEX
    // ================================================================
    match /FriendshipIndex/{indexId} {
      allow read: if isAuth();
      allow create, delete: if isAuth();
    }

    // ================================================================
    // FEEDBACK
    // ================================================================
    match /Feedback/{feedbackId} {
      allow read: if isAdmin();
      allow create: if isAuth();
    }

    // ================================================================
    // COMMUNITY MESSAGES
    // ================================================================
    match /CommunityMessages/{messageId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAuth();
    }

    // ================================================================
    // ROADMAP (admin-managed)
    // ================================================================
    match /Roadmap/{itemId} {
      allow read: if isAuth();
      allow create, update, delete: if isAdmin();
    }

    // ================================================================
    // CUSTOM MARKER TYPES
    // ================================================================
    match /CustomMarkerTypes/{typeId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAuth() && request.auth.token.email == resource.data.userId;
    }

    // ================================================================
    // TOOL SUGGESTIONS
    // ================================================================
    match /ToolSuggestions/{docId} {
      allow create: if isAuth();
      allow read: if isAdmin();
    }
  }
}
